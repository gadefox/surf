#!/bin/sh

PREFIX="/usr/local"
VERSION="2.2"
WIN_WIDTH=800
WIN_HEIGHT=600

verbose=0
debug=0
dump=0
shell="/bin/rc"
scroll=1
title=1
fullscreen=1

red=31
green=32
yellow=33
blue=34
magenda=35
cyan=36
white=37

printc () {
  printf "\033[%d;1m%b\033[0m" $1 "$2"
}

ok () {
  printc $green "\tOK\n"
}

fail () {
  printc $red "\tFAIL\n"
}

warn () {
  printc $yellow "warning: "
  printf "%b\n" "$1"
}

status () {
  printf $2
  if [ $1 = 0 ]; then
    ok
  else
    fail
    exit 1
  fi
}

bin () {
  type $1 >/dev/null 2>&1
  status $? $1
}

lib () {
  pkg-config $1 >/dev/null 2>&1
  # $? == 0?
  status $? $1
}

bins () {
  printc $white "checking building tools..\n"
  bin pkg-config
  bin rm
  bin mkdir
  bin cp
  bin chmod
  bin strip
  bin gzip
  bin rc
}

libs () {
  printc $white "checking surf libraries..\n"
  SURF_LIB_NAMES="x11 webkit2gtk-4.1 gtk+-3.0 gcr-3 json-glib-1.0"
  for i in $SURF_LIB_NAMES; do
    lib $i
  done
  printc $white "checking webext libraries..\n"
  WEBEXT_LIB_NAMES="webkit2gtk-web-extension-4.1 gio-2.0 json-glib-1.0"
  for i in $WEBEXT_LIB_NAMES; do
    lib $i
  done
}

append () {
  printf "%b\n" "$*" >>config.mk
}

config () {
  printc $white "creating configuration file"
  append "# Generated by configure script"
  append "BIN_DIR = $PREFIX/bin"
  append "LIB_DIR = $PREFIX/lib"
  append "LIBEXEC_DIR = $PREFIX/libexec"
  append "MAN_DIR = $PREFIX/share/man/man1\n"
  if [ $verbose = 1 ]; then
    append "QUIET_CC = "
    append "QUIET_LINK = "
  else
    append "QUIET_CC = @echo 'CC '\$@;"
    append "QUIET_LINK = @echo 'LINK '\$@;"
  fi

  append "\nSURF_CFLAGS = `pkg-config --cflags $SURF_LIB_NAMES` -DVERSION=\\\"$VERSION\\\" -DSHELL=\\\"$surf\\\" -DSURF_RC=\\\"$PREFIX/libexec/surf/surf.rc\\\" -DWEBEXT_DIR=\\\"$PREFIX/lib/surf\\\" -DGCR_API_SUBJECT_TO_CHANGE"
  [ $debug = 1 ] && append "SURF_CFLAGS += -g -DDEBUG" || append "SURF_CFLAGS += -O3"
  [ $dump = 1 ] && append "SURF_CFLAGS += -DDUMP"
  [ -z $WIN_WIDTH ] || [ -z $WIN_HEIGHT ] || append "SURF_CFLAGS += -DWIN_WIDTH=$WIN_WIDTH -DWIN_HEIGHT=$WIN_HEIGHT"
  [ $scroll = 1 ] && append "SURF_CFLAGS += -DFEATURE_SCROLL"
  [ $title = 1 ] && append "SURF_CFLAGS += -DFEATURE_TITLE"
  [ $fullscreen = 1 ] && append "SURF_CFLAGS += -DFEATURE_FULLSCREEN"
  append "\nSURF_LIBS = `pkg-config --libs $SURF_LIB_NAMES` -lgthread-2.0"
  
  append "\nWEBEXT_CFLAGS = `pkg-config --cflags $WEBEXT_LIB_NAMES`"
  [ $debug = 1 ] && append "WEBEXT_CFLAGS += -g -DDEBUG" || append "WEBEXT_CFLAGS += -O3"
  [ $dump = 1 ] && append "WEBEXT_CFLAGS += -DDUMP"
  [ $scroll = 1 ] && append "WEBEXT_CFLAGS += -DFEATURE_SCROLL"
  append "\nWEBEXT_LIBS = `pkg-config --libs $WEBEXT_LIB_NAMES`"

  ok
}

printf "configure: create 'config.mk' include file\n"
for arg; do
  opt=${arg%%=*}
  var=${arg#*=}
  case "$opt" in
    --verbose)
      verbose=1
    ;;
    --debug)
      debug=1
    ;;
    --dump)
      dump=1
    ;;
    --prefix)
      PREFIX="$var"
    ;;
    --shell)
      shell="$var"
    ;;
    --rc)
      SURF_RC="$var"
    ;;
    --winsize)
      WIN_WIDTH=${var%%:*}
      WIN_HEIGHT=${var#*:}
    ;;
    --disable-winsize)
      WIN_WIDTH=
      WIN_HEIGHT=
    ;;
    --disable-scroll)
      scroll=0
    ;;
    --disable-title)
      title=0
    ;;
    --disable-fullscreen)
      fullscreen=0
    ;;
    -h|--help)
      printf "usage: ./"
      printc $white "configure "
      printf "[--verbose] [--debug] [--dump] [--prefix=<dir>] [--shell=<bin>] [--rc=<path>] [--winsize=<width:height>] [--disable-winsize] [--disable-scroll] [--disable-title] [--disable-fullscreen]\n"
      exit 1
    ;;
    *)
      warn "unknown option $opt" >&2
    ;;
  esac
done

bins
libs
config

printf "type "
printc $white "make"
printf " to build the program\n"
